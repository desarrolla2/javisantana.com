<!DOCTYPE html>
<html>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <head>
    <title></title>
    <link rel="stylesheet" href="assets/css/style2.css" type="text/css" />
    <link rel="stylesheet" href="assets/css/pygments.css" type="text/css" />
  </head>
  <body>
    <header>
      <a href="/">javisantana.com</a>
    </header>
    <div id="content">
    <h1 id='animaciones_en_javascript'>Animaciones en javascript</h1>

<p>Ahora que javascript está tan de moda, es tan potente y nos permite hacer lo que código nativo nos permitía hacer en un 486 los desarrolladores estamos empezando a hacer cosas algo más interesantes que poner texto y enlaces como juegos o animaciones. Lo cierto es que a pesar de que javascript sea aún lento para hacer cosas con mucha carga matemática, tenemos a nuestra disposición tarjetas gráficas muy potentes y gracias a las mejoras que últimamente han incluído en los navegadores, podemos usarlas directamente (con WebGL) o indirectamente (CSS3, SVG, canvas)</p>

<p>El objetivo de este artículo no es explicar como renderizar rápido ni de como aprovechar la GPU si no de <strong>como hacer una animación</strong>.</p>

<h2 id='paso_1_setinterval'>paso 1: setInterval</h2>

<p>Lo primero que se nos ocurre es el típico <a href='https://developer.mozilla.org/en/DOM/window.setInterval'>setInterval</a>. Seguro que conoces la función, pero básicamente lo que hace es llamar a una función que le especificas cada cierto tiempo. Por ejemplo, la animación sería tal que así:</p>
<div class='highlight'><pre><code class='javascript'>        <span class='nx'>setInterval</span><span class='p'>(</span><span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
            <span class='nx'>update</span><span class='p'>()</span>
            <span class='nx'>render</span><span class='p'>();</span>
        <span class='p'>},</span> <span class='mi'>20</span><span class='p'>)</span>

    
</code></pre>
</div>
<p>Esto llamará a la función cada 20ms, esto es 50 frames por segundo (FPS). Para la mayoría de casos cumple perfectamente. Pero qué pasa si la función update tarda 30ms en terminar? Realmente no sé que es lo que hace el navegador, supongo que cada uno tendrá su política, pero cabe pensar que con el tiempo se empezarán a aculumar eventos de llamada a esa función ya que no es capaz de terminar en menos de 20ms.</p>

<p>Aunque el navegador fuese muy listo y gestionase eso perfectamente no podemos hacer la animación correctamente porque no sabemos el tiempo que ha pasado de un frame a otro.</p>

<h2 id='paso_2_settimeout'>paso 2: setTimeout</h2>

<p>Para evitar que se nos acumulen llamadas por que la función es lenta vamos a pedir renderizar un frame solo cuando hayamos terminado:</p>
<div class='highlight'><pre><code class='javascript'>        <span class='kd'>var</span> <span class='nx'>logic</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
            <span class='nx'>update</span><span class='p'>()</span>
            <span class='nx'>render</span><span class='p'>();</span>
            <span class='nx'>setTimeout</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>,</span> <span class='mi'>20</span><span class='p'>);</span>
        <span class='p'>};</span>
        <span class='nx'>setTimeout</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>);</span>

    
</code></pre>
</div>
<p>Vale, ahora ya no se acumulan eventos y si la función update o render tarda más que esos 20ms no pasará nada, sólo actualizaré la animación cuando el frame anterior haya terminado. Mejor que antes pero aún estamos animando como unos tristes.</p>

<h2 id='paso3_controlando_la_animacin'>paso3: controlando la animación</h2>

<p>Imaginemos que estamos controlando una animación de una imagen moviendose por la pantalla. Queremos que en 1 segundo se mueva 500px:</p>
<div class='highlight'><pre><code class='javascript'>        <span class='kd'>var</span> <span class='nx'>img</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nx'>Image</span><span class='p'>();</span>
        <span class='nx'>img</span><span class='p'>.</span><span class='nx'>src</span> <span class='o'>=</span> <span class='s1'>&#39;image.png&#39;</span><span class='p'>;</span>
        <span class='nx'>img</span><span class='p'>.</span><span class='nx'>style</span><span class='p'>[</span><span class='s1'>&#39;position&#39;</span><span class='p'>]</span> <span class='o'>=</span> <span class='s1'>&#39;absolute&#39;</span><span class='p'>;</span>
        <span class='kd'>var</span> <span class='nx'>pos</span> <span class='o'>=</span> <span class='mi'>0</span><span class='p'>;</span>
        <span class='nx'>img</span><span class='p'>.</span><span class='nx'>style</span><span class='p'>[</span><span class='s1'>&#39;left&#39;</span><span class='p'>]</span> <span class='o'>=</span> <span class='nx'>pos</span> <span class='o'>+</span> <span class='s1'>&#39;px&#39;</span><span class='p'>;</span>

        <span class='kd'>var</span> <span class='nx'>logic</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>

            <span class='c1'>// update</span>
            <span class='nx'>pos</span> <span class='o'>+=</span> <span class='mi'>500</span><span class='o'>*</span><span class='mf'>0.02</span><span class='p'>;</span>
            <span class='nx'>img</span><span class='p'>.</span><span class='nx'>style</span><span class='p'>[</span><span class='s1'>&#39;left&#39;</span><span class='p'>]</span> <span class='o'>=</span> <span class='nx'>pos</span> <span class='o'>+</span> <span class='s1'>&#39;px&#39;</span><span class='p'>;</span>

            <span class='c1'>// browser will render the img on style change</span>
            <span class='c1'>//render();</span>
            <span class='k'>if</span><span class='p'>(</span><span class='nx'>pos</span> <span class='o'>&lt;</span> <span class='mi'>500</span><span class='p'>)</span> <span class='p'>{</span>
                <span class='nx'>setTimeout</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>,</span> <span class='mi'>20</span><span class='p'>);</span>
            <span class='p'>}</span>
        <span class='p'>};</span>
        <span class='nx'>setTimeout</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>);</span>

    
</code></pre>
</div>
<p>En un segundo, a 50FPS habremos dibujado 50 frames con lo cual pos será 500 al pasar un segundo. No está mal, pero imaginemos que tenemos una máquina lenta, tan lenta que no es capaz de actualizar a 50FPS. En ese caso tendremos que la imagen llegará a la posición 500px, pero en más de un segundo. No estamos controlando el tiempo.</p>

<p>Para ello podemos usar el tiempo transcurrido desde el último frame. Vamos, lo que se lleva aplicando en videojuegos simples toda la vida:</p>
<div class='highlight'><pre><code class='javascript'>        <span class='kd'>var</span> <span class='nx'>t0</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nb'>Date</span><span class='p'>().</span><span class='nx'>getTime</span><span class='p'>();</span>
        <span class='kd'>var</span> <span class='nx'>logic</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
            <span class='kd'>var</span> <span class='nx'>t1</span> <span class='o'>=</span> <span class='k'>new</span> <span class='nb'>Date</span><span class='p'>().</span><span class='nx'>getTime</span><span class='p'>();</span>
            <span class='kd'>var</span> <span class='nx'>dt</span> <span class='o'>=</span> <span class='nx'>t1</span> <span class='o'>-</span> <span class='nx'>t0</span><span class='p'>;</span>
            <span class='nx'>t0</span> <span class='o'>=</span> <span class='nx'>t1</span><span class='p'>;</span>

            <span class='c1'>// update</span>
            <span class='nx'>pos</span> <span class='o'>+=</span> <span class='mi'>500</span><span class='o'>*</span><span class='nx'>dt</span><span class='p'>;</span>
            <span class='nx'>img</span><span class='p'>.</span><span class='nx'>style</span><span class='p'>[</span><span class='s1'>&#39;left&#39;</span><span class='p'>]</span> <span class='o'>=</span> <span class='nx'>pos</span> <span class='o'>+</span> <span class='s1'>&#39;px&#39;</span><span class='p'>;</span>

            <span class='c1'>// browser will render the img on style change</span>
            <span class='c1'>//render();</span>
            <span class='k'>if</span><span class='p'>(</span><span class='nx'>pos</span> <span class='o'>&lt;</span> <span class='mi'>500</span><span class='p'>)</span> <span class='p'>{</span>
                <span class='nx'>setTimeout</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>,</span> <span class='mi'>20</span><span class='p'>);</span>
            <span class='p'>}</span>
        <span class='p'>};</span>
        <span class='nx'>setTimeout</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>,</span> <span class='mi'>0</span><span class='p'>);</span>

    
</code></pre>
</div>
<p>Ya está, ahora aunque la máquina sea lenta controlamos la animación correctamente</p>

<h2 id='paso_4_requestanimationframe'>paso 4: requestAnimationFrame</h2>

<p>Ahora podemos controlar un poco mejor la animación gracias a <a href='https://developer.mozilla.org/en/DOM/window.requestAnimationFrame'>requestAnimationFrame</a>. Para variar es una función que no es standard y cada navegador la implementa con el nombre que le da la real gana.</p>

<p>En resumen, esta función llama a la función que nostros queramos cuando el navegador vaya a renderizar. Eso es bueno, por que si nosotros llamamos 1000 veces por segundo a esta función como mucho llamará a la animación el máximo que pueda actualizar. Asumamos que esto es bueno, aunque si estás haciendo algo medio serio la actualización de la lógica puede ir parcialmente desacoplada del renderizado (luego veremos un ejemplo).</p>

<p>Así que la cosa quedaría tal que así:</p>
<div class='highlight'><pre><code class='javascript'>        <span class='kd'>var</span> <span class='nx'>logic</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
            <span class='kd'>var</span> <span class='nx'>dt</span> <span class='o'>=</span> <span class='c1'>//calculate dt</span>
            <span class='nx'>uddate</span><span class='p'>(</span><span class='nx'>dt</span><span class='p'>);</span>
            <span class='nx'>render</span><span class='p'>()</span>
            <span class='nx'>requestAnimationFrame</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>);</span>
        <span class='p'>}</span>
        <span class='nx'>requestAnimationFrame</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>);</span>
    
</code></pre>
</div>
<p>Perfecto, además podemos llamar a requestAnimationFrame desde cualquier lado para que comience la animación.</p>

<p>Normalmente (la ley del copy &amp; paste así lo dice) se define requestAnimationFrame tal que así:</p>
<div class='highlight'><pre><code class='javascript'>        <span class='kd'>var</span> <span class='nx'>requestAnimationFrame</span> <span class='o'>=</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>requestAnimationFrame</span> <span class='o'>||</span>
                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>webkitRequestAnimationFrame</span> <span class='o'>||</span>
                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>mozRequestAnimationFrame</span> <span class='o'>||</span>
                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>oRequestAnimationFrame</span> <span class='o'>||</span>
                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>msRequestAnimationFrame</span> <span class='o'>||</span>
                <span class='kd'>function</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>){</span><span class='nx'>setTimeout</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>,</span><span class='mi'>20</span><span class='p'>);};</span>
    
</code></pre>
</div>
<p>aunque en mi opinión debería ser algo así:</p>
<div class='highlight'><pre><code class='javascript'>        <span class='kd'>function</span> <span class='nx'>createRequestAnimationFrame</span><span class='p'>(</span><span class='nx'>fn</span><span class='p'>)</span> <span class='p'>{</span>
            <span class='kd'>var</span> <span class='nx'>rendered</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
            <span class='k'>return</span> <span class='nb'>window</span><span class='p'>.</span><span class='nx'>requestAnimationFrame</span> <span class='o'>||</span>
                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>webkitRequestAnimationFrame</span> <span class='o'>||</span>
                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>mozRequestAnimationFrame</span> <span class='o'>||</span>
                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>oRequestAnimationFrame</span> <span class='o'>||</span>
                <span class='nb'>window</span><span class='p'>.</span><span class='nx'>msRequestAnimationFrame</span> <span class='o'>||</span>
                <span class='kd'>function</span><span class='p'>(</span><span class='nx'>a</span><span class='p'>)</span> <span class='p'>{</span>
                    <span class='k'>if</span><span class='p'>(</span><span class='nx'>rendered</span><span class='p'>)</span> <span class='p'>{</span>
                        <span class='nx'>rendered</span> <span class='o'>=</span> <span class='kc'>false</span><span class='p'>;</span>
                        <span class='nx'>setTimeout</span><span class='p'>(</span><span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
                            <span class='nx'>fn</span><span class='p'>();</span>
                            <span class='nx'>rendered</span> <span class='o'>=</span> <span class='kc'>true</span><span class='p'>;</span>
                        <span class='p'>},</span> <span class='mi'>20</span><span class='p'>);</span>
                    <span class='p'>}</span>
                <span class='p'>};</span>
        <span class='p'>}</span>

        <span class='nx'>logic</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span>
            <span class='nx'>update</span><span class='p'>();</span>
            <span class='nx'>myAnimationRequestFrame</span><span class='p'>();</span>
        <span class='p'>}</span>
        <span class='nx'>myAnimationRequestFrame</span> <span class='o'>=</span> <span class='nx'>createRequestAnimationFrame</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>);</span>
        <span class='nx'>myAnimationRequestFrame</span><span class='p'>();</span>

        <span class='nx'>element</span><span class='p'>.</span><span class='nx'>onclick</span> <span class='o'>=</span> <span class='kd'>function</span><span class='p'>()</span> <span class='p'>{</span> 
            <span class='c1'>// logic</span>
            <span class='nx'>myAnimationRequestFrame</span><span class='p'>();</span>
        <span class='p'>}</span>
    
</code></pre>
</div>
<p>De este modo aunque llamemos 1000 veces a myAnimationRequestFrame sólo se llamará a la animación cuando toque</p>

<h2 id='paso_5_casos_extremos'>paso 5: casos extremos</h2>

<p>Qué pasa si el navegador es muy lento. Bueno, lo ideal es quitar la animación, pero claro, no sabemos a priori si la máquina es lenta (bueno, puedes comprobar si es Firefox). Para evitar que todo se vaya al traste quizá lo mejor sea limitar la animación para que no se vaya de madre.</p>
<div class='highlight'><pre><code class='javascript'>        <span class='kd'>var</span> <span class='nx'>logic</span> <span class='o'>=</span> <span class='kd'>function</span> <span class='p'>()</span> <span class='p'>{</span>
            <span class='kd'>var</span> <span class='nx'>dt</span> <span class='o'>=</span> <span class='c1'>//calculate dt</span>
            <span class='nx'>dt</span> <span class='o'>=</span> <span class='nb'>Math</span><span class='p'>.</span><span class='nx'>min</span><span class='p'>(</span><span class='mf'>0.05</span><span class='p'>,</span> <span class='nx'>dt</span><span class='p'>);</span>
            <span class='nx'>update</span><span class='p'>(</span><span class='nx'>dt</span><span class='p'>);</span>
            <span class='nx'>render</span><span class='p'>()</span>
            <span class='nx'>requestAnimationFrame</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>);</span>
        <span class='p'>}</span>
        <span class='nx'>requestAnimationFrame</span><span class='p'>(</span><span class='nx'>logic</span><span class='p'>);</span>
    
</code></pre>
</div>
<p>De esta forma si la animación es muy lenta la ralentizamos pero así estamos seguros de que la lógica no falla. También nos protege del caso en el que el usuario cambie de tab (requestAnimationFrame no asegura que se llame al callback si la pestaña donde se ejecuta el código no está activa), al volver a activarse el dt será muy grande y podría desestabilizar en caso de no controlar el dt. Imagino que habrá algún API para controlar si la pestaña es activa&#8230;</p>

<p>Imaginemos que la función update hace algo más complejo que sumar, por ejemplo una integración numérica. En ese caso si el dt es muy grande la integración se puede ir al traste, necesitamos dt suficientemente pequeños. Ese caso quedaría resuelto también.</p>

<p>Por ejemplo, queremos que en el ejemplo anterior la imagen vaya hasta 500 pero suavemente:</p>
<div class='highlight'><pre><code class='javascript'>        <span class='kd'>var</span> <span class='nx'>smooth</span> <span class='o'>=</span> <span class='mf'>0.1</span><span class='p'>;</span>
        <span class='kd'>var</span> <span class='nx'>distance_to_target</span> <span class='o'>=</span> <span class='mi'>500</span> <span class='o'>-</span> <span class='nx'>pos</span><span class='p'>;</span>
        <span class='nx'>pos</span> <span class='o'>+=</span> <span class='nx'>distance_to_target</span><span class='o'>*</span><span class='nx'>smooth</span><span class='o'>*</span><span class='nx'>dt</span><span class='p'>;</span>
    
</code></pre>
</div>
<p>Si dt es muy grande lo que pasará es que esa función empezará a oscilar haciendo un efecto muelle en vez de llegar suavemente o incluso oscilará hasta el infinito si dt es muy grande (a que os suena de de cuando érais jóvenes y estudiabais? si eres teleco/industrial y no te suena vuelve a la carrera).</p>

<h2 id='y_ltimo_haciendo_las_cosas_realmente_bien'>y último: haciendo las cosas realmente bien</h2>

<p>Mejor que explicarlo aquí, id a este artículo del mítico Javier Arévalo y grabadlo en vuestra mente:</p>

<p><a href='http://www.iguanademos.com/Jare/Articles.php?view=FixLoop'>Fixed time step loop</a></p>

<h3 id='comentarios_y_trolleos_son_bienvenidos'>Comentarios y trolleos son bienvenidos</h3>

<p><a href='https://twitter.com/javisantana'>@javisantana</a></p>
    </div>
  </body>
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-165269-5']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
   </script>
</html>
